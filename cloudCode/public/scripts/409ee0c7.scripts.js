"use strict";angular.module("tqgApp",[]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:qs",{templateUrl:"views/anon.html",controller:"AnonCtrl"}).when("/game/:gid",{templateUrl:"views/game.html",controller:"GameCtrl"}).when("/new/:gid",{templateUrl:"views/gameCreate.html",controller:"NewGameCtrl"}).otherwise({redirectTo:"/"})}]),Parse.initialize("Ek7zH223q2oVU53Hcq71x6ZBusHR4mrSyFbOIwli","PLHaBNxLzNHSqHdyeqDrohQPNsppckv8mrPXlnVa"),window.fbAsyncInit=function(){console.log("init"),Parse.FacebookUtils.init({appId:"148740492001273",channelUrl:"//thequestionsgame.parseapp.com/channel.html",cookie:!0,xfbml:!0,status:!0})},angular.module("tqgApp").controller("MainCtrl",["$scope",function(){}]);var GameCtrl=angular.module("tqgApp").controller("GameCtrl",["$scope","$routeParams","$location","User","Game",function(a,b,c,d,e){a.gameId=b.gid,a.user=d,a.game=e,e.getGame(a.gameId)}]);GameCtrl.$inject=["$scope","$routeParams","$location","User","Game"];var User=angular.module("tqgApp").service("User",["$route","$rootScope",function(a,b){var c=this;this.fbuser=null,this.currentUser=Parse.User.current(),this.fetchFbUserData=function(){console.log("fetching user data"),FB.api("/me",function(a){b.$apply(function(){c.fbuser=a,c.username=c.fbuser.name,c.refreshParseUser()}),b.$broadcast("progressBar.update",!1),console.log("fetched fb user information")})},this.refreshParseUser=function(){c.currentUser.get("name")!==c.fbuser.name||c.currentUser.get("email")!==c.fbuser.email||c.currentUser.get("firstName")!==c.fbuser.first_name?(console.log("changing user name from ",c.currentUser.get("name")," to ",c.fbuser.name),console.log("changing e-mail from ",c.currentUser.get("email")," to ",c.fbuser.email),console.log("changing first_name from ",c.currentUser.get("firstName")," to ",c.fbuser.first_name),c.currentUser.set("name",c.fbuser.name),c.currentUser.set("firstName",c.fbuser.first_name),c.currentUser.set("email",c.fbuser.email),c.currentUser.set("facebookid",c.fbuser.id),c.currentUser.save()):console.log("user name or e-mail or first_name did not change")},this.logIn=function(){Parse.FacebookUtils.logIn("",{success:function(b){console.log("logged in"),console.log(b),a.reload()},error:function(a,b){console.error("User cancelled the Facebook login or did not fully authorize."),console.error(b)}})},this.logOut=function(){console.log("logout"),Parse.User.logOut(),a.reload()},this.loggedIn=function(){return null!==Parse.User.current()},console.log("logged in "+c.loggedIn()),c.loggedIn()&&c.fetchFbUserData()}]);User.$inject=["$route","$rootScope"];var Game=angular.module("tqgApp").service("Game",["$location","$rootScope",function(a,b){var c=this;this.currentGame=null,this.currentPlayers=[],this.currentQuestion="",this.rolesChoices=[{id:0,name:"one question"}],this.questionsSets=[],this.questionsChoices=[],this.newGame={gameGod:Parse.User.current(),gameId:null,rule:0,questionsSet:0},this.getGame=function(d){var e=new Parse.Query("Game");e.equalTo("gameId",d),e.find({success:function(e){console.log("got games"),console.log(e),0===e.length?b.$apply(function(){a.path("/new/"+d)}):(b.$apply(function(){c.currentGame=e[0],e[0].relation("players").add(Parse.User.current()),e[0].save()}),e[0].relation("players").query().notEqualTo("objectId",Parse.User.current().id).find({success:function(a){console.log("got game players"),console.log(a),b.$apply(function(){console.log(a),c.currentPlayers=a})},error:function(a){console.error(a)}}),Parse.Cloud.run("getQuestion",{userId:Parse.User.current().id,gameId:e[0].id},{success:function(a){console.log("got question"),console.log(a),b.$apply(function(){c.currentQuestion=a})},error:function(a){console.error(a)}}))},error:function(){console.log("create new game")}})},this.saveGame=function(d){var e=new Parse.Object.extend("Game"),f=new e;void 0===d&&(d=c.newGame),f.save(d,{success:function(c){console.log("created game"),console.log(c),console.log(c.get("gameId")),b.$apply(function(){a.path("/"+c.get("gameId"))}),c.relation("players").add(Parse.User.current()),c.save()},error:function(a){console.log(a)}})};var d=new Parse.Query("QuestionsSet");d.find({success:function(a){console.log("fetched questions sets"),console.log(a),b.$apply(function(){c.questionsSets=a,a.forEach(function(a){c.questionsChoices.push({id:a.id,name:a.get("name")})})})},error:function(a){console.error(a)}})}]);Game.$inject=["$location"];var login=angular.module("tqgApp").directive("login",["User",function(a){return{template:"<button>Login with Facebook</button>",restrict:"E",link:function(b,c){c.bind("click",function(){a.logIn()})}}}]);login.$inject=["User"];var logout=angular.module("tqgApp").directive("logout",["$window","User",function(a,b){return{template:'<a href="#"><i class="logout-ico"></i><span class="text">Logout</span></a>',restrict:"E",link:function(c,d){d.bind("click",function(c){return c.preventDefault(),a.confirm("Are you sure?")&&b.logOut(),!1})}}}]);logout.$inject=["$window","User"];var NewGameCtrl=angular.module("tqgApp").controller("NewGameCtrl",["$scope","$routeParams","$location","User","Game",function(a,b,c,d,e){a.gameId=b.gid,a.user=d,a.game=e,a.game.getGame(a.gameId),a.game.newGame.gameId=a.gameId}]);NewGameCtrl.$inject=["$scope","$routeParams","$location","User","Game"];var AnonCtrl=angular.module("tqgApp").controller("AnonCtrl",["$scope","$routeParams","$location","User","Game",function(a,b){var c=b.qs;a.currentQuestion="",Parse.Cloud.run("getAnonQuestion",{idx:c},{success:function(b){a.$apply(function(){a.currentQuestion=b})}})}]);AnonCtrl.$inject=GameCtrl.$inject=["$scope","$routeParams","$location","User","Game"];